syntax = "proto3";

package com.fanaujie.ripple.protobuf;

option java_multiple_files = true;
option java_package = "com.fanaujie.ripple.protobuf.msggateway";

import "MessageAPI.proto";
import "Push.proto";

// Event types that can be pushed to users via gateway
enum PushEventType {
  PUSH_EVENT_TYPE_UNSPECIFIED = 0;
  PUSH_EVENT_TYPE_SELF_INFO_UPDATE = 1;
  PUSH_EVENT_TYPE_RELATION_UPDATE = 2;
  PUSH_EVENT_TYPE_CONVERSATION_UPDATE = 3;
}

// Message types for gateway push
enum PushMessageType {
  PUSH_MESSAGE_TYPE_UNSPECIFIED = 0;
  PUSH_MESSAGE_TYPE_SINGLE = 1;
  PUSH_MESSAGE_TYPE_GROUP = 2;
}

// Event payload - can contain multiple event types
message PushEventPayload {
  repeated PushEventType event_types = 1;
}

// Message payload - contains the actual message
message PushMessagePayload {
  PushMessageType message_type = 1;
  SendMessageReq message_data = 2;
  int32 unread_count = 3;  // recipient's unread count for this conversation
}

// SSE payload - for bot streaming responses
message PushSSEPayload {
  SSEEventType event_type = 1;
  string conversation_id = 2;
  string content = 3;               // delta text / full text / error message
  int64 message_id = 4;             // only set when event_type is DONE
  int64 send_timestamp = 5;
}

// Main request structure
message PushMessageRequest {
  string send_user_id = 1;
  string receive_user_id = 2;
  string receive_device_id = 3;

  oneof payload {
    PushEventPayload event_payload = 4;
    PushMessagePayload message_payload = 5;
    PushSSEPayload sse_payload = 6;
  }
}

message PushMessageResponse {
  string send_user_id = 1;
  string receive_user_id = 2 ;
  bool  is_success = 3;
}

message BatchPushMessageRequest {
  repeated PushMessageRequest requests = 1;
}

message BatchPushMessageResponse {
  repeated PushMessageResponse responses = 1;
}

service MessageGateway {
  rpc PushMessageToUser(BatchPushMessageRequest) returns (BatchPushMessageResponse);
}